<!doctype html>
<!--
Copyright 2017, Google, Inc.
Licensed under the Apache License, Version 2.0 (the 'License');
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an 'AS IS' BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
  <head>
    <title>Agent Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        background-color: #f4f7f6;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      h1 {
        background-color: #2c3e50;
        color: white;
        padding: 20px;
        text-align: center;
        margin-bottom: 0;
      }
      .container {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      .sidebar {
        width: 250px;
        background-color: #34495e;
        color: white;
        padding: 15px;
        overflow-y: auto;
        border-right: 1px solid #2c3e50;
      }
      .sidebar h2 {
        font-size: 1.2em;
        margin-top: 0;
        margin-bottom: 15px;
        border-bottom: 1px solid #4a6782;
        padding-bottom: 10px;
      }
      #chatTabs {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }
      #chatTabs li.chat-tab {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #4a6782;
        transition: background-color 0.2s ease;
      }
      #chatTabs li.chat-tab:hover {
        background-color: #4a6782;
      }
      #chatTabs li.chat-tab.selected {
        background-color: #2980b9;
        font-weight: bold;
      }
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #ffffff;
        border-left: 1px solid #e0e0e0;
      }
      #chatWindows {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
      }
      ul.chat-window {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }
      ul.chat-window li {
        padding: 8px 10px;
        margin-bottom: 5px;
        border-radius: 5px;
      }
      ul.chat-window li.operator-message {
        background-color: #e0f2f7;
        color: #2980b9;
        text-align: right;
        margin-left: 20%;
      }
      ul.chat-window li.operator-message::before { content: ""; } /* Remove default prefix */
      ul.chat-window li.customer-message {
        background-color: #f0f0f0;
        color: #333;
        text-align: left;
        margin-right: 20%;
      }
      ul.chat-window li.agent-response {
        font-style: italic;
        background-color: #f9f9f9;
        color: #666;
      }
      ul.chat-window li.operator-error {
        background-color: #ffebee;
        color: #c0392b;
        font-weight: bold;
      }
      form {
        background: #ecf0f1;
        padding: 10px 15px;
        display: flex;
        border-top: 1px solid #e0e0e0;
      }
      form input {
        flex: 1;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        margin-right: 10px;
        font-size: 1em;
      }
      form button {
        background: #2980b9;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.2s ease;
      }
      form button:hover {
        background-color: #2471a3;
      }
    </style>
  </head>
  <body>
    <h1>Operator Dashboard</h1>
    <div class="container">
      <div class="sidebar">
        <h2>Active Sessions</h2>
        <ul id="chatTabs">
        </ul>
      </div>
      <div class="main-content">
        <div id="chatWindows">
        </div>
        <form>
          <input id="m" autocomplete="off" placeholder="Type a message..." /><button>Send</button>
        </form>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
      $(function () {
        var socket = io('/operator');

        // UI elements for all the customers we currently aware of
        var connectedCustomers = {};
        // Pointer to the currently open tab
        var currentTab;

        // The format we use to communicate a message to a specific customer
        var messageObject = function(customerId, utterance) {
          return { customerId: customerId, utterance: utterance };
        };

        // When the form is submitted, send an operator message to the server, referencing
        // the current tab's customer
        $('form').submit(function(){
          if(!currentTab) {
            alert('Please select a customer to chat with.');
            return false;
          }
          if(currentTab.disconnected) {
            alert('This customer has disconnected');
            return false;
          }
          var messageText = $('#m').val();
          if (messageText.trim() === '') { // Prevent sending empty messages
            return false;
          }
          socket.emit('operator message', messageObject(currentTab.customerId, messageText));
          $('#m').val('');
          return false;
        });

        // Switch to a different tab
        var setCurrentTab = function(target) {
            // Do nothing if this is already the current tab
            if(currentTab === target) return;
            // Set the current tab
            currentTab = target;
            // Remove any other selected tab
            $('li.chat-tab').removeClass('selected');
            // Mark this tab as selected
            target.tab.addClass('selected');
            // Hide any other chat windows
            $('.chat-window').hide();
            // Show this chat window
            target.window.show();
            // Scroll to bottom of chat window
            target.window.scrollTop(target.window[0].scrollHeight);
        };

        // Create a set of UI elements for a new customer tab.
        // The customerId is the ID used internally by for websocket communication.
        // In your implementation, you could replace this with the customer's name
        // after fetching it from your datastore.
        var createNewCustomerTab = function(customerId) {
          var newChatElements = {};
          newChatElements.customerId = customerId;
          // A tab displaying the customer id
          newChatElements.tab = $('<li class="chat-tab">').text('Customer ' + customerId.substring(0, 8)); // Shorten ID for display
          // The chat log for this customer
          newChatElements.window = $('<ul class="chat-window">').hide();

          var clickHandler = function() {
            setCurrentTab(newChatElements);
          };
          newChatElements.tab.click(clickHandler);

          connectedCustomers[customerId] = newChatElements;

          if(!currentTab) {
            console.log('Setting current tab');
            clickHandler();
          }

          $('#chatTabs').append(newChatElements.tab);
          $('#chatWindows').append(newChatElements.window);
        };

        // Notify the operator that a customer has requested them
        var notifyOperatorRequest = function(customerId) {
          if(!connectedCustomers[customerId]) {
            console.log('Received operator request from unknown customer id: ' + customerId);
            return;
          }
          setCurrentTab(connectedCustomers[customerId]);
          alert('Operator requested!');
        };

        // Notify the operator that a customer has disconnected
        var notifyCustomerDisconnected = function(customerId) {
          if(!connectedCustomers[customerId]) {
            console.log('Received disconnect notification for unknown customer id: ' + customerId);
            return;
          }
          connectedCustomers[customerId].disconnected = true;
          connectedCustomers[customerId]
            .window
            .append($('<li class="customer-message disconnected">')
            .text('--- Customer disconnected ---'));
            connectedCustomers[customerId].tab.addClass('disconnected-tab');
        };

        // Notify the operator of a system error
        var notifySystemError = function(error) {
          var errorText;
          // If we get this custom error type, the error was due to an operator mistake; display it
          // in a friendlier manner (without the word 'Error')
          if(error.type === 'CustomerModeError') {
            errorText = error.message;
          // Otherwise, print the error type and message
          } else {
            errorText = error.type + ' - ' + error.message;
          }
          console.log(errorText);
          if(!currentTab) return;
          currentTab.window.append($('<li class="operator-error">').text(errorText));
          currentTab.window.scrollTop(currentTab.window[0].scrollHeight);
        };

        // Display messages sent by any operator to the customers this operator knows about
        var receivedOperatorMessage = function(msg) {
          var customer = connectedCustomers[msg.customerId];
          if(!customer) {
            console.log('Received operator message to unknown customer id: ' + JSON.stringify(msg));
            return;
          }
          customer.window
            .append($('<li class="operator-message">').text(msg.utterance));
          customer.window.scrollTop(customer.window[0].scrollHeight);
        };

        // Display messages sent by customers
        var receivedCustomerMessage = function(msg) {
          if(!connectedCustomers[msg.customerId]) {
            console.log('Received message for unknown customer id: ' + JSON.stringify(msg));
            return;
          }
          // If your implementation has access to the customer's name,
          // you can modify the next line to display it in the prefix.
          var prefix = msg.isAgentResponse ? 'Agent: ' : 'Customer: ';
          connectedCustomers[msg.customerId]
            .window
            .append($('<li class="customer-message">')
            .toggleClass('agent-response', msg.isAgentResponse)
            .text(prefix + msg.utterance));
          connectedCustomers[msg.customerId].window.scrollTop(connectedCustomers[msg.customerId].window[0].scrollHeight);
        };

        // Attach all our event handlers
        socket.on('customer connected', createNewCustomerTab);
        socket.on('customer message', receivedCustomerMessage);
        socket.on('operator requested', notifyOperatorRequest);
        socket.on('operator message', receivedOperatorMessage);
        socket.on('customer disconnected', notifyCustomerDisconnected);
        socket.on('system error', notifySystemError);

      });
    </script>
  </body>
</html>

